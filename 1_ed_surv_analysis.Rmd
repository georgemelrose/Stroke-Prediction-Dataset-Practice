---
title: "1 - Exploratory Data & Survival Analysis"
author: "George Melrose"
date: "`r Sys.Date()`"
output: 
 html_document:
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

rm(list = ls())

knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)

pacman::p_load(tidyverse,knitr,kableExtra,finalfit,lubridate,data.table,
               janitor,flextable,rmdHelpers, ggrepel,survminer,survival,
               scales,RColorBrewer,GGally,DT,gtsummary,cardx,
               ggsurvfit,patchwork,rsample)

```



## Exploratory Data Analysis - Summary Statistics {.tabset .tabset-fade .tabset-pills}

### First look at the data

```{r loading in data}
stroke_data <- read_csv("stroke_data.csv")
```

```{r looking at the data}
str(stroke_data)
```

```{r checking overall dataset summarys stats and missingess}
ff_glimpse(stroke_data)
```

```{r reorder factor variable levels, echo=FALSE}

#work type#

stroke_data$work_type <- factor(stroke_data$work_type , levels = c("Private", "Govt_job", "Self-employed")) %>% relevel(ref = "Private")

levels(stroke_data$work_type)

#smoking status#

stroke_data$smoking_status <- factor(stroke_data$smoking_status , levels = c("never smoked", "formerly smoked", "smokes")) %>% relevel(ref = "never smoked")

levels(stroke_data$smoking_status)

#residence type#

stroke_data$residence_type <- factor(stroke_data$residence_type , levels = c("Urban", "Rural"))

levels(stroke_data$residence_type)

```


```{r generating factor variables}

stroke_data <- stroke_data %>% mutate(across(c(hypertension_yn,heart_disease_yn,
                                    stroke_yn,age_category,bmi_category,ever_married,
                                    gender), ~ factor(.x)))


```

```{r doing ff labels for different variables, echo = FALSE}
stroke_data$age_category <- stroke_data$age_category %>%
  ff_label("Age(years)")

stroke_data$bmi <- stroke_data$bmi %>%
  ff_label("BMI")

stroke_data$bmi_category <- stroke_data$bmi_category %>%
  ff_label("BMI (category)")

stroke_data$ever_married <- stroke_data$ever_married %>%
  ff_label("Ever Married?")

stroke_data$gender <- stroke_data$gender %>%
  ff_label("Gender")

stroke_data$residence_type <- stroke_data$residence_type %>%
  ff_label("Residence Type")

stroke_data$smoking_status <- stroke_data$smoking_status %>%
  ff_label("Smoking Status")

stroke_data$work_type <- stroke_data$work_type %>%
  ff_label("Work Type")

stroke_data$hypertension_yn <- stroke_data$hypertension_yn %>%
  ff_label("Hypertension(Yes/No)")

stroke_data$heart_disease_yn<- stroke_data$heart_disease_yn %>%
  ff_label("Heart Disease (Yes/No)")

stroke_data$stroke_yn<- stroke_data$stroke_yn %>%
  ff_label("Stroke Outcome (Yes/No)")

ff_glimpse(stroke_data)

```

### Age

```{r removing child age category}
#dropping children from age category#


summary(stroke_data$age_category)

```

Summary statistics for age -

```{r summary statistics for the age variable}

summary(stroke_data$age)

```

-   From the summary statistics we see that the mean and median are 50.2
    years and 50.5 years respectively. This is an indication of the age
    variable being normally distributed.

-   The minimum age is 18 as per the earlier filtering removing all
    children. The maximum age of a patient is 82.

```{r counting the numbers and proportions of patients in the three different age categories}
age_counts <- stroke_data %>%
  group_by(age_category) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(age_category)

age_counts_table <- age_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Age Category" = age_category)

flextable(age_counts_table)

```

```{r plotting distribution of patients across age categories}

ggplot(age_counts, aes(x = age_category, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by Age Category",
       x = "Age Category",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```

The above bar chart is further confirmation that the age variable is
indeed normally distributed.

```{r making an age counts table stratified by stroke yes or no}
age_counts_w_stroke <- stroke_data %>%
  group_by(age_category,stroke_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
                 percentage = signif(percentage, 3)) %>%
  arrange(age_category)

age_counts_w_stroke_table <- age_counts_w_stroke %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Age Category" = age_category) %>% rename("Stroke (Yes/No)" = stroke_yn)

flextable(age_counts_w_stroke_table)
```

The table above displaying the no.patients in each age category
stratified by those having or not having a stroke shows that the
no.patients having a stroke is heavily skewed towards the oldest age
category. 13.6% of patients in the \>60 age category had a stroke, 3.62%
of patients in the 36-60 age category had a stroke, and just 1
patients/0.0959% of patients in the 18-35 age category had a stroke.

```{r plotting distribution of patients across age and stroke categories}

ggplot(age_counts_w_stroke, aes(x = age_category, y = patient_count, fill = stroke_yn)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(aes(label = patient_count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of Patients by Age Category and Stroke Status",
       x = "Age Category",
       y = "Number of Patients",
       fill = "Stroke") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  )

```

### BMI

Summary statistics for BMI -

```{r summary statistics for the bmi variable}

#summary statistics for bmi#

summary(stroke_data$bmi)

```

-   From the summary statistics we see that the mean and median BMIs are
    29.2 and 30.4 respectively. This is an indication of the BMI
    variable being normally distributed. The maximum and minimum BMI
    values of 11.3 and 92 are way beyond any conceivable measurements
    and so may be outliers that need to be removed. There are 181 NAs
    out of 4,254 observations.

```{r counting the numbers and proportions of patients in the four different bmi categories}
bmi_counts <- stroke_data %>%
  group_by(bmi_category) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(bmi_category)

bmi_counts_table <- bmi_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("BMI Category" = bmi_category)

flextable(bmi_counts_table)

```

The above table shows that this dataset has the vast majority of
patients as overweight and obese, with only 20.3% at a normal, healthy
BMI.

```{r plotting distribution of patients across bmi categories}
#Code to remove NAs from bmi_counts#

bmi_counts <- bmi_counts %>% filter(!is.na(bmi_category))


ggplot(bmi_counts, aes(x = bmi_category, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by BMI Category",
       x = "BMI Category",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```

The distribution of patients is left skewed towards the 'Overweight' and
'Obese' categories.

```{r making an bmi counts table stratified by stroke yes or no}
bmi_counts_w_stroke <- stroke_data %>%
  group_by(bmi_category,stroke_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
                 percentage = signif(percentage, 3)) %>%
  arrange(bmi_category)

bmi_counts_w_stroke_table <- bmi_counts_w_stroke %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("BMI Category" = bmi_category) %>% rename("Stroke (Yes/No)" = stroke_yn)

flextable(bmi_counts_w_stroke_table)
```

The above summary table shows the percentage of patients having a stroke
is higher in the 'Overweight' and 'Obese' BMI categories than in the
'Normal Weight' and 'Underweight' categories.

```{r plotting distribution of patients across bmi and stroke categories}

bmi_counts_w_stroke <- bmi_counts_w_stroke %>% filter(!is.na(bmi_category))

ggplot(bmi_counts_w_stroke, aes(x = bmi_category, y = patient_count, fill = stroke_yn)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(aes(label = patient_count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of Patients by BMI Category and Stroke Status",
       x = "BMI Category",
       y = "Number of Patients",
       fill = "Stroke") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  )

```

There is a higher rate of stroke associated with the 'Overweight' and
'Obese' BMI categories but perhaps not a significant level.

### Gender

```{r counting the numbers and proportions of patients by gender}
gender_counts <- stroke_data %>%
  group_by(gender) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(gender)

gender_counts_table <- gender_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Gender" = gender)

flextable(gender_counts_table)

```

The cohort is majority female at 60.6% and 39.4% male. One patient is
marked as 'other'. It is unclear what this means - an input mistake,
transgender? To not disturb any other modelling, this patient is
removed.

```{r removing the one patient who has gender as other}

stroke_data <- stroke_data %>% filter(gender == "Male" | gender == "Female")

```

```{r plotting distribution of patients across the genders}
#redoing gender counts to reflect removed 'other' patient'
gender_counts <- stroke_data %>%
  group_by(gender) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(gender)

ggplot(gender_counts, aes(x = gender, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by Gender",
       x = "Gender",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```

```{r making a gender counts table stratified by stroke yes or no}
gender_counts_w_stroke <- stroke_data %>%
  group_by(gender,stroke_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
                 percentage = signif(percentage, 3)) %>%
  arrange(gender)

gender_counts_w_stroke_table <- gender_counts_w_stroke %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Gender" = gender) %>% rename("Stroke (Yes/No)" = stroke_yn)

flextable(gender_counts_w_stroke_table)
```

Interestingly, whilst there are many more female than male patients, the
rate of stroke between the 2 genders stays consistent. 5.4% (139) of
females experienced stroke and 6.44% (108) of males experienced stroke.

```{r plotting distribution of patients across gender and stroke categories}
ggplot(gender_counts_w_stroke, aes(x = gender, y = patient_count, fill = stroke_yn)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(aes(label = patient_count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of Patients by Gender and Stroke Status",
       x = "Gender",
       y = "Number of Patients",
       fill = "Stroke") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  )

```

### Marriage

```{r counting the numbers and proportions of patients by marriage}
ever_married_counts <- stroke_data %>%
  group_by(ever_married) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(ever_married)

ever_married_counts_table <- ever_married_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Marriage?" = ever_married)

flextable(ever_married_counts_table)

```

```{r plotting distribution of patients across by marriage}

ggplot(ever_married_counts, aes(x = ever_married, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by Marriage",
       x = "Ever Married?",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```

```{r making a marriage counts table stratified by stroke yes or no}
ever_married_counts_w_stroke <- stroke_data %>%
  group_by(ever_married,stroke_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
                 percentage = signif(percentage, 3)) %>%
  arrange(ever_married)

ever_married_counts_w_stroke_table <- ever_married_counts_w_stroke %>% rename("Percentage (%)" = percentage) %>% rename("No.Patients" = patient_count) %>% rename("Ever Married?" = ever_married) %>% rename("Stroke (Yes/No)" = stroke_yn)

flextable(ever_married_counts_w_stroke_table)
```

The above table shows that the proportion of those patients experiencing
stroke who had ever married (6.56%) was more than twice as much as the
proportion of patients experiencing stroke who had never married (3%).

```{r plotting distribution of patients across marriage and stroke categories}
ggplot(ever_married_counts_w_stroke, aes(x = ever_married, y = patient_count, fill = stroke_yn)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(aes(label = patient_count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of Patients by Marriage Status and Stroke Status",
       x = "Ever Married(?)",
       y = "Number of Patients",
       fill = "Stroke") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  )

```

### Hypertension

```{r counting the numbers and proportions of patients by hypertension}
hypertension_counts <- stroke_data %>%
  group_by(hypertension_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(hypertension_yn)

hypertension_counts_table <- hypertension_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Hypertension?" = hypertension_yn)

flextable(hypertension_counts_table)

```

```{r plotting distribution of patients across by hypertension}

ggplot(hypertension_counts, aes(x = hypertension_yn, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by Hypertension",
       x = "Hypertension?",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```

```{r making a hypertension counts table stratified by stroke yes or no}
hypertension_counts_w_stroke <- stroke_data %>%
  group_by(hypertension_yn,stroke_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
                 percentage = signif(percentage, 3)) %>%
  arrange(hypertension_yn)

hypertension_counts_w_stroke_table <- hypertension_counts_w_stroke %>% rename("Percentage (%)" = percentage) %>% rename("No.Patients" = patient_count) %>% rename("Hypertension?" = hypertension_yn) %>% rename("Stroke (Yes/No)" = stroke_yn)

flextable(hypertension_counts_w_stroke_table)
```

```{r plotting distribution of patients across hypertension and stroke categories}
ggplot(hypertension_counts_w_stroke, aes(x = hypertension_yn, y = patient_count, fill = stroke_yn)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(aes(label = patient_count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of Patients by Hypertension Status and Stroke Status",
       x = "Hypertension(?)",
       y = "Number of Patients",
       fill = "Stroke") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  )

```

The proportion of patients with hypertension who had a stroke (13.3%) is
2.75x higher than the proportion of patients without hypertension who
had a stroke (4.82%).

### Work Type

```{r counting the numbers and proportions of patients by work type}
work_counts <- stroke_data %>%
  group_by(work_type) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(work_type)

work_counts_table <- work_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Work Type" = work_type)

flextable(work_counts_table)

```

```{r plotting distribution of patients across by work type}

ggplot(work_counts, aes(x = work_type, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by Work Type",
       x = "Work Type",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```

### Chi-squared & Fisher's Exact Tests

```{r doing ff labels for different variables, echo = FALSE}
stroke_data$age_category <- stroke_data$age_category %>%
  ff_label("Age(years)")

stroke_data$bmi_category <- stroke_data$bmi_category %>%
  ff_label("BMI")

stroke_data$ever_married <- stroke_data$ever_married %>%
  ff_label("Ever Married?")

stroke_data$gender <- stroke_data$gender %>%
  ff_label("Gender")

stroke_data$residence_type <- stroke_data$residence_type %>%
  ff_label("Residence Type")

stroke_data$smoking_status <- stroke_data$smoking_status %>%
  ff_label("Smoking Status")

stroke_data$work_type <- stroke_data$work_type %>%
  ff_label("Work Type")
```

```{r removing underweight bmi category}
# Recode 'Unknown' to NA in all relevant columns
stroke_data$bmi_category <- factor(stroke_data$bmi_category) # Ensure smoking_status is a factor
stroke_data$bmi_category[stroke_data$bmi_category  == "Underweight"] <- NA

# Optionally drop the 'Unknown' level from the factor levels
stroke_data$bmi_category <- droplevels(stroke_data$bmi_category)

stroke_data$bmi_category <- stroke_data$bmi_category %>%
  ff_label("BMI")
```

#### Chi-squared tests

```{r chi squared tests for explanatory variables and stroke}
 stroke_data %>% 
  summary_factorlist(dependent = "stroke_yn", 
                     explanatory = 
                       c("age_category", "bmi_category","ever_married","gender",
                         "heart_disease_yn", "hypertension_yn","residence_type",
                         "smoking_status","work_type"),
                     p = TRUE) %>%
     kable("html") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  )


```

#### Fisher's exact tests

```{r fishers test for explanatory variables and stroke}
 stroke_data %>% 
  summary_factorlist(dependent = "stroke_yn", 
                     explanatory = 
                       c("age_category", "bmi_category","ever_married","gender",
                         "heart_disease_yn", "hypertension_yn","residence_type",
                         "smoking_status","work_type"),
                     p = TRUE,
                     p_cat = "fisher") %>%
     kable("html") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    position = "center"
  )


```

### Facetted Visualisations

```{r stroke outcomes and hypertension statuses facetted by age and gender}
p1 <- stroke_data %>% 
  ggplot(aes(x = hypertension_yn, fill=stroke_yn)) + 
  geom_bar(position = position_stack(reverse = TRUE)) +
  facet_grid(gender ~ age_category) + 
  theme(legend.position = "none")

p2 <- stroke_data %>% 
  ggplot(aes(x = hypertension_yn, fill=stroke_yn)) + 
  geom_bar(position = position_fill(reverse = TRUE)) +
  facet_grid(gender ~ age_category)+ 
  theme(legend.position = "bottom")

p1 / p2
```

```{r hypertension statuses facetted by stroke}
p1 <- stroke_data %>% 
  ggplot(aes(x = hypertension_yn, fill = stroke_yn)) + 
  geom_bar(position = position_stack(reverse = TRUE)) +
  labs(
    x = "Hypertension Status",
    y = "Number of Patients",
    fill = "Stroke Status"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 10),
    legend.position = "none"
  )

p2 <- stroke_data %>% 
  ggplot(aes(x = hypertension_yn, fill = stroke_yn)) + 
  geom_bar(position = position_fill(reverse = TRUE)) + 
  scale_y_continuous(labels = percent) + # Convert y-axis to percentage
  labs(
    x = "Hypertension Status",
    y = "Proportion (%)",
    fill = "Stroke Status"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 10),
    legend.position = "right"
  )

p1 + p2
```

```{r ages facetted by stroke}
p1 <- stroke_data %>% 
  ggplot(aes(x = age_category, fill = stroke_yn)) + 
  geom_bar(position = position_stack(reverse = TRUE)) +
  labs(
    x = "Age Category",
    y = "Number of Patients",
    fill = "Stroke Status"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 10),
    legend.position = "none"
  )

p2 <- stroke_data %>% 
  ggplot(aes(x = age_category, fill = stroke_yn)) + 
  geom_bar(position = position_fill(reverse = TRUE)) + 
  scale_y_continuous(labels = percent) + # Convert y-axis to percentage
  labs(
    x = "Age Category",
    y = "Proportion (%)",
    fill = "Stroke Status"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 10),
    legend.position = "right"
  )

p1 + p2
```

## Survival Analysis {.tabset .tabset-fade .tabset-pills}

```{r rounding numeric time columns, echo=FALSE}
stroke_data$follow_up_time_days <- round(stroke_data$follow_up_time_days, 0)

stroke_data$follow_up_years <- round(stroke_data$follow_up_years, 2)
```

```{r creating a survival curve using the KM method, echo=FALSE}

fit_stroke <- survfit(Surv(follow_up_years, status) ~ 1, data = stroke_data)

str(fit_stroke)
```

### Overall Survival

```{r visualising survival for all subjects}
ggsurvplot(
  fit_stroke,
  xlim = c(0, 5),
  ylim = c(0.7, 1),
  break.time.by = 1,
  xlab = "Years since Study Start",
  ylab = "Survival Probability",
  pval = TRUE,
  ggtheme = theme_minimal() + theme(
    panel.grid.major = element_blank(), # Remove major grid lines
    panel.grid.minor = element_blank(), # Remove minor grid lines
    panel.background = element_blank(), # Remove panel background
    plot.background = element_blank(),  # Remove plot background
    axis.line = element_line(color = "black"), # Keep axis lines
    axis.title = element_text(size = 14), # Increase axis title size
    axis.text = element_text(size = 12),  # Increase axis text size
    legend.text = element_text(size = 15), # Increase legend text size
    legend.title = element_text(size = 20), # Increase legend title size
    plot.title = element_text(size = 20), # Increase plot title size
    plot.subtitle = element_text(size = 13), # Increase plot subtitle size
    legend.key.size = unit(1, "lines")      # Adjust legend key size
  ),
  risk.table = TRUE,
  risk.table.y.text.col = TRUE,
  risk.table.height = 0.2,                 # Slightly increase height of risk table
  risk.table.y.text = TRUE,
  conf.int = TRUE,
  cumcensor = FALSE,
  conf.int.style = "step",
  risk.table.fontsize = 4,                 # Reduce risk table font size
  risk.table.title = "Subjects at Risk",   # Set risk table title
  tables.theme = theme_minimal() + theme(
    axis.text.x = element_text(size = 12), # Adjust x-axis text in risk table
    axis.text.y = element_text(size = 12)  # Adjust y-axis text in risk table
  )
)


```

```{r estimating 3 year survival}

summary(survfit(Surv(follow_up_years, status) ~ 1, data = stroke_data), times = 5)

```

```{r estimating 3 year survival rate table}
survfit(Surv(follow_up_years, status) ~ 1, data = stroke_data) %>% 
  tbl_survfit(
    times = 3,
    label_header = "**5-year survival (95% CI)**"
  )


```

```{r estimating the median survival time}
stroke_data %>% 
  filter(status == 1) %>% 
  summarize(median_surv = median(follow_up_years))
```

### Smoking Status

```{r comparing survival time for smoking status, echo=FALSE}

survfit(Surv(follow_up_years, status) ~ smoking_status, data = stroke_data)

fit_smoking <- survfit(Surv(follow_up_years, status) ~ smoking_status, data = stroke_data)
```

```{r survival curve for smoking,fig.width=11.5,fig.height=5.3,fig.align = 'center'}

legend_labels <- c("never smoked", "formerly smoked", "smokes")

ggsurvplot(
  fit_smoking,
  xlim = c(0, 5),
  ylim = c(0.7, 1),
  break.time.by = 1,
  xlab = "Years since Study Start",
  ylab = "Survival Probability",
  pval = TRUE,
  ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                  axis.title = element_text(size = 13), # Increase axis title size
                  axis.text = element_text(size = 11),  # Increase axis text size
                  legend.text = element_text(size = 13), # Increase legend text size
                  legend.title = element_text(size = 16), # Increase legend title size
                  plot.title = element_text(size = 14), # Increase plot title size
                  plot.subtitle = element_text(size = 13), # Increase plot subtitle size
                  legend.key.size = unit(1.5, "lines") # Increase legend key size
                ),
           risk.table = TRUE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.35,
           risk.table.y.text = FALSE,
           conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.76), pval.method = TRUE, pval.method.coord = c(0, 0.72),
           legend.labs = legend_labels,
           legend.title = "Smoking Status",pval.size = 5, pval.method.size = 5 # Set legend title
             #font.x = c(0, "plain", "white") # Removes x-axis text from KM plot

)
```

Quantifying the effect size for multiple variables using Cox Regression
-

Some key assumptions of the model:

-   non-informative censoring
-   proportional hazards

```{r calculating the HR of smoking status}
coxph(Surv(follow_up_years, status) ~ smoking_status, data = stroke_data) %>% 
  tbl_regression(exp = TRUE) 
```

### Age

```{r comparing survival time for age categories, echo=FALSE}

survfit(Surv(follow_up_years, status) ~ age_category, data = stroke_data)

fit_age <- survfit(Surv(follow_up_years, status) ~ age_category, data = stroke_data)
```

```{r survival curve for age categories,fig.width=11.5,fig.height=5.3,fig.align = 'center'}
legend_labels <- c("<60","60-69","70-79",">80")

ggsurvplot(
  fit_age,
  xlim = c(0, 5),
  ylim = c(0.7, 1),
  break.time.by = 1,
  xlab = "Years since Study Start",
  ylab = "Survival Probability",
  pval = TRUE,
  ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                  axis.title = element_text(size = 13), # Increase axis title size
                  axis.text = element_text(size = 11),  # Increase axis text size
                  legend.text = element_text(size = 13), # Increase legend text size
                  legend.title = element_text(size = 16), # Increase legend title size
                  plot.title = element_text(size = 14), # Increase plot title size
                  plot.subtitle = element_text(size = 13), # Increase plot subtitle size
                  legend.key.size = unit(1.5, "lines") # Increase legend key size
                ),
           risk.table = TRUE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.35,
           risk.table.y.text = FALSE,
           conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.76), pval.method = TRUE, pval.method.coord = c(0, 0.72),
           legend.labs = legend_labels,
           legend.title = "Age Category",pval.size = 5, pval.method.size = 5 # Set legend title

)
```

```{r calculating the HR of age categories}
coxph(Surv(follow_up_years, status) ~ age_category, data = stroke_data) %>% 
  tbl_regression(exp = TRUE) 
```

### Gender

```{r comparing survival time for gender, echo=FALSE}

survfit(Surv(follow_up_years, status) ~ gender, data = stroke_data)

fit_gender <- survfit(Surv(follow_up_years, status) ~ gender, data = stroke_data)
```

```{r survival curve for gender categories,fig.width=11.5,fig.height=5.3,fig.align = 'center'}
legend_labels <- c("Female", "Male")

ggsurvplot(
  fit_gender,
  xlim = c(0, 5),
  ylim = c(0.7, 1),
  break.time.by = 1,
  xlab = "Years since Study Start",
  ylab = "Survival Probability",
  pval = TRUE,
  ggtheme = theme_minimal() + theme(
                  panel.grid.major = element_blank(), # Remove major grid lines
                  panel.grid.minor = element_blank(), # Remove minor grid lines
                  panel.background = element_blank(), # Remove panel background
                  plot.background = element_blank(),  # Remove plot background
                  axis.line = element_line(color = "black"), # Keep axis lines if desired
                  axis.title = element_text(size = 13), # Increase axis title size
                  axis.text = element_text(size = 11),  # Increase axis text size
                  legend.text = element_text(size = 13), # Increase legend text size
                  legend.title = element_text(size = 16), # Increase legend title size
                  plot.title = element_text(size = 14), # Increase plot title size
                  plot.subtitle = element_text(size = 13), # Increase plot subtitle size
                  legend.key.size = unit(1.5, "lines") # Increase legend key size
                ),
           risk.table = TRUE,
           risk.table.y.text.col = TRUE,
           risk.table.height = 0.35,
           risk.table.y.text = FALSE,
           conf.int = TRUE, cumcensor = FALSE, conf.int.style = "step",pval.coord = c(0, 0.76), pval.method = TRUE, pval.method.coord = c(0, 0.72),
           legend.labs = legend_labels,
           legend.title = "Gender",pval.size = 5, pval.method.size = 5 # Set legend title

)
```

```{r calculating the HR of gender categories}
coxph(Surv(follow_up_years, status) ~ gender, data = stroke_data) %>% 
  tbl_regression(exp = TRUE) 
```

### Cox Regression {.tabset .tabset-fade .tabset-pills}

#### Model 1 - All explanatory variables

```{r Model 1 with all relevant explanatory variables}
dependent = "Surv(follow_up_years, stroke)"
dependent_label = "Strokes over 5 Years"

vars_multi = c("age_category", "bmi_category","ever_married","gender",
                         "heart_disease_yn", "hypertension_yn","residence_type",
                         "smoking_status","work_type")


tab = stroke_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE) 


mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# data manipulation and kable code
 result <- tab[[1]] %>%
  rename(!!{{ dependent_label }} := label) %>%
  rename(" " = levels) %>%
  rename("  " = all)

# Apply mykable to the result
 mykable(result)

 tab[[1]] %>%
   rename({{dependent_label}} := label) %>%
   rename(" " = levels) %>%
   rename("  " = all) %>%
   mykable()
```

```{r model 1 HR plot, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

stroke_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()


```

Key takeaways from Model 1:

-   A good concordance/C-statistic. This indicates how well the model
    predicts the order of events. A value of 0.747 means that in 74.7%
    of the cases, the model correctly predicts that a patient who had a
    stroke earlier was at higher risk than a patient who did not or had
    the event later. Values range from 0.5 (no better than random
    guessing) to 1.0 (perfect prediction). The model's concordance is
    reasonably good.

-   R-squared measures how much of the variability in (stroke
    occurrence) is explained by the model. Here, your model explains
    4.8% of the variability in stroke risk. The max possible R-squared
    of 0.576 represents the theoretical upper bound if the model
    perfectly explained the outcome variance. This low R-squared is
    likely attributable to the random generation of follow-up times -
    not real data!

-   The likelihood ratio test compares the model to a null model (with
    no predictors). A high test statistic with a very low p-value (p =
    0.000) indicates that the model significantly improves the fit
    compared to the null model. This confirms that the predictors
    collectively contribute to explaining stroke risk.

-   With 247 events out of 4253 individuals, the model has a moderate
    number of events to estimate the relationships. The concordance SE
    of 0.018 shows a relatively tight estimate of the concordance,
    suggesting reliable ranking performance.

#### Model 2 - BMI and 'Work Type' excluded

```{r model 2 wo bmi or work type}
dependent = "Surv(follow_up_years, stroke)"
dependent_label = "Strokes over 5 Years"

vars_multi = c("age_category","ever_married","heart_disease_yn", "hypertension_yn",
               "residence_type","smoking_status")


tab = stroke_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE) 


mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# Your data manipulation and kable code
 result <- tab[[1]] %>%
  rename(!!{{ dependent_label }} := label) %>%
  rename(" " = levels) %>%
  rename("  " = all)

# Apply mykable to the result
 mykable(result)

 tab[[1]] %>%
   rename({{dependent_label}} := label) %>%
   rename(" " = levels) %>%
   rename("  " = all) %>%
   mykable()
```

```{r model 2 HR plot, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

stroke_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()


```

#### Model 3 - Only Statistically Significant Variables

```{r model 3 with only statistically significant variables}
dependent = "Surv(follow_up_years, stroke)"
dependent_label = "Strokes over 5 Years"

vars_multi = c("age_category","heart_disease_yn", "hypertension_yn",
               "smoking_status")


tab = stroke_data %>% 
  finalfit(dependent, vars_multi, metrics = TRUE, add_dependent_label = FALSE) 


mykable = function(x){
    knitr::kable(x, row.names = FALSE, align = c("l", "l", "r", "r", "r", "r", "r", "r", "r"))
}

# Your data manipulation and kable code
 result <- tab[[1]] %>%
  rename(!!{{ dependent_label }} := label) %>%
  rename(" " = levels) %>%
  rename("  " = all)

# Apply mykable to the result
 mykable(result)

 tab[[1]] %>%
   rename({{dependent_label}} := label) %>%
   rename(" " = levels) %>%
   rename("  " = all) %>%
   mykable()
```

```{r model 3 HR plot, warning=FALSE, message=FALSE, include = TRUE, echo = FALSE,fig.width=10,fig.height=5,fig.align = 'center'}

stroke_data %>% 
  hr_plot(dependent, vars_multi,
          breaks = c(0.03,0.1,0.3,1,3,10),
          remove_ref = TRUE,
          column_space = c(-1,0,0.75),
          table_text_size = 3,
          title_text_size = 16,
          dependent_label = dependent_label) 

tab[[2]] %>% knitr::kable()


```
