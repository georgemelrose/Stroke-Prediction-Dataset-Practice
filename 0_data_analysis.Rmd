---
title: "Stroke Data Analysis"
author: "George Melrose"
date: "`r Sys.Date()`"
output: 
 html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}

rm(list = ls())

knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)

pacman::p_load(tidyverse,icd,knitr,kableExtra,finalfit,lubridate,data.table,
               janitor,flextable,survival,survminer,cmprsk,rmdHelpers, ggrepel,
               scales,RColorBrewer,GGally,randomForest, caret,DT)

```

## Formatting Data

```{r loading in data}
stroke_data <- read_csv("healthcare-dataset-stroke-data.csv.csv")
```
```{r}
str(stroke_data)
```


```{r removing children from the dataset and format binary variables}

#Removing children as lifestyle factors will be far less connected to pediatric stroke - https://www.stroke.org.uk/stroke/childhood/about #

#No.rows with children#
print(paste("The number of rows of the data with children included -", nrow(stroke_data)))

#Removing children by filtering out all rows with age<18#
children <- stroke_data %>% filter(age < 18)

print(paste("The number of rows of the data that are children (age<18) -", nrow(children)))

stroke_data <- stroke_data %>% filter(age >= 18)

print(paste("The number of rows of the data without children included -", nrow(stroke_data)))

#Creating yes/no (yn) versions of the binary outcome variables#
stroke_data$hypertension_yn <- as.factor(ifelse(stroke_data$hypertension == 1, "Yes", "No"))
stroke_data$heart_disease_yn <- as.factor(ifelse(stroke_data$heart_disease == 1, "Yes", "No"))
stroke_data$stroke_yn <- as.factor(ifelse(stroke_data$stroke == 1, "Yes", "No"))

#re-leveling above yn variables to have "No" as the default and adding ff_label command for cleaner formatting in finalfit plots#

stroke_data <- stroke_data %>% mutate(
  hypertension_yn = relevel(factor(hypertension_yn), ref = "No") %>% 
    ff_label("Hypertension (Yes/No)"),
  
  heart_disease_yn = relevel(factor(heart_disease_yn), ref = "No") %>% 
    ff_label("Heart Disease (Yes/No)"),
  
  stroke_yn = relevel(factor(stroke_yn), ref = "No") %>% 
    ff_label("Stroke (Yes/No)")
)

```

```{r adding follow up time for survival analysis}
set.seed(123)  # For reproducibility

# Simulate follow-up times in days
stroke_data <- stroke_data %>% 
  mutate(
    follow_up_time_days = runif(n(), min = 0, max = 1825),  # Time between 0 and 5 years for all
    # Assume the event occurs within the observed time or they are censored
    status = ifelse(stroke == 1, 1, 0)  # 1 = event (stroke), 0 = censored (no stroke)
  )

# Assuming you already have a follow-up time in days
stroke_data <- stroke_data %>%
  mutate(
    follow_up_time_days = as.numeric(follow_up_time_days),  # Replace with your column name
    follow_up_years = follow_up_time_days / 365         # Convert days to years
  )

# Show sample data with follow-up time in days
head(stroke_data)

datatable(stroke_data[1:10, ],options = list(scrollX = TRUE))
```



```{r making categorical variables of numeric variables}
stroke_data$bmi <- as.numeric(stroke_data$bmi)

stroke_data <- stroke_data %>% mutate(
  # Create age categories
  age_category = case_when(
    age < 18 ~ "<18",
    age >= 18 & age <= 35 ~ "18-35",
    age > 35 & age <= 60 ~ "36-60",
    age > 60 ~ ">60"
  ) %>% factor(levels = c("<18", "18-35", "36-60", ">60")),
  
  # Create BMI categories
  bmi_category = case_when(
    bmi < 18.5 ~ "Underweight",
    bmi >= 18.5 & bmi <= 24.9 ~ "Normal weight",
    bmi >= 25 & bmi <= 29.9 ~ "Overweight",
    bmi >= 30 ~ "Obese",
    TRUE ~ NA_character_
  ) %>% factor(levels = c("Underweight", "Normal weight", "Overweight", "Obese"))
  
)
  
```

```{r}
# Check how many NAs are in the categorical variable and inspect its unique values
na_categorical_count <- sum(is.na(stroke_data$bmi_category))
cat("Number of NAs in categorical BMI variable:", na_categorical_count, "\n")

# View unique BMI category values
unique(stroke_data$bmi_category)
```






The average glucose level variable can be considered redundant or less informative for exploratory data analysis (EDA) without additional context about when the readings were taken. 

Glucose levels can fluctuate significantly based on factors such as fasting status, recent meals, and time of day. For example, a reading taken shortly after eating will typically be higher than a fasting reading - 

```{r blood glucose chart,  fig.cap="Blood Glucose Chart from 'Lark Health' "}
knitr::include_graphics("BloodGlucoseChart.jpeg")
```

Without knowing the conditions under which the glucose levels were measured, it becomes difficult to draw meaningful conclusions or identify trends during EDA. A reading labeled as "normal" may not actually reflect the patientâ€™s metabolic health.

```{r removing glucose level variable from dataset and looking at data types of dataset}
stroke_data <- stroke_data %>% select(-avg_glucose_level)

str(stroke_data)

datatable(stroke_data[1:10, ],options = list(scrollX = TRUE))
```



## Exploratory Data Analysis - Summary Statistics {.tabset .tabset-fade .tabset-pills}

### Age
Summary statistics for age - 

```{r summary statistics for the age variable}

summary(stroke_data$age)

```

* From the summary statistics we see that the mean and median are 50.2 years and 50.5 years respectively. This is an indication of the age variable being normally distributed. 

* The minimum age is 18 as per the earlier filtering removing all children. The maximum age of a patient is 82. 

```{r counting the numbers and proportions of patients in the three different age categories}
age_counts <- stroke_data %>%
  group_by(age_category) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(age_category)

age_counts_table <- age_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Age Category" = age_category)

flextable(age_counts_table)

```





```{r plotting distribution of patients across age categories}
ggplot(age_counts, aes(x = age_category, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by Age Category",
       x = "Age Category",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```

The above bar chart is further confirmation that the age variable is indeed normally distributed. 

```{r making an age counts table stratified by stroke yes or no}
age_counts_w_stroke <- stroke_data %>%
  group_by(age_category,stroke_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
                 percentage = signif(percentage, 3)) %>%
  arrange(age_category)

age_counts_w_stroke_table <- age_counts_w_stroke %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("Age Category" = age_category) %>% rename("Stroke (Yes/No)" = stroke_yn)

flextable(age_counts_w_stroke_table)
```

The table above displaying the no.patients in each age category stratified by those having or not having a stroke shows that the no.patients having a stroke is heavily skewed towards the oldest age category. 13.6% of patients in the >60 age category had a stroke, 3.62% of patients in the 36-60 age category had a stroke, and just 1 patients/0.0959% of patients in the 18-35 age category had a stroke. 


```{r plotting distribution of patients across age and stroke categories}
ggplot(age_counts_w_stroke, aes(x = age_category, y = patient_count, fill = stroke_yn)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(aes(label = patient_count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of Patients by Age Category and Stroke Status",
       x = "Age Category",
       y = "Number of Patients",
       fill = "Stroke") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  )

```

### BMI

Summary statistics for BMI - 

```{r summary statistics for the bmi variable}

#summary statistics for bmi#

summary(stroke_data$bmi)

```
* From the summary statistics we see that the mean and median BMIs are 29.2 and 30.4 respectively. This is an indication of the BMI variable being normally distributed. The maximum and minimum BMI values of 11.3 and 92 are way beyond any conceivable measurements and so may be outliers that need to be removed. There are 181 NAs out of 4,254 observations.

```{r counting the numbers and proportions of patients in the four different bmi categories}
bmi_counts <- stroke_data %>%
  group_by(bmi_category) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
        percentage = signif(percentage, 3)) %>%
  arrange(bmi_category)

bmi_counts_table <- bmi_counts %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("BMI Category" = bmi_category)

flextable(bmi_counts_table)

```

The above table shows that this dataset has the vast majority of patients as overweight and obese, with only 20.3% at a normal, healthy BMI. 

```{r plotting distribution of patients across bmi categories}
#Code to remove NAs from bmi_counts#

bmi_counts <- bmi_counts %>% filter(!is.na(bmi_category))


ggplot(bmi_counts, aes(x = bmi_category, y = patient_count)) +
  geom_col(fill = "blue", alpha = 0.8) +
  geom_text(aes(label = patient_count), vjust = -0.5, size = 3.5, color = "darkblue") +
  scale_y_continuous(labels = comma) +
  labs(title = "Number of Patients by BMI Category",
       x = "BMI Category",
       y = "Number of Patients") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  ) 

```


The distribution of patients is left skewed towards the 'Overweight' and 'Obese' categories. 


```{r making an bmi counts table stratified by stroke yes or no}
bmi_counts_w_stroke <- stroke_data %>%
  group_by(bmi_category,stroke_yn) %>%
  summarise(patient_count = n()) %>%
  mutate(percentage = (patient_count / sum(patient_count)) * 100,
                 percentage = signif(percentage, 3)) %>%
  arrange(bmi_category)

bmi_counts_w_stroke_table <- bmi_counts_w_stroke %>% rename("Percentage (%)" = percentage) %>% rename(
"No.Patients" = patient_count) %>% rename("BMI Category" = bmi_category) %>% rename("Stroke (Yes/No)" = stroke_yn)

flextable(bmi_counts_w_stroke_table)
```

The above summary table shows the percentage of patients having a stroke is higher in the 'Overweight' and 'Obese' BMI categories than in the 'Normal Weight' and 'Underweight' categories. 

```{r plotting distribution of patients across age and stroke categories}

bmi_counts_w_stroke <- bmi_counts_w_stroke %>% filter(!is.na(bmi_category))

ggplot(bmi_counts_w_stroke, aes(x = bmi_category, y = patient_count, fill = stroke_yn)) +
  geom_col(position = "dodge", alpha = 0.8) +
  geom_text(aes(label = patient_count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Number of Patients by BMI Category and Stroke Status",
       x = "BMI Category",
       y = "Number of Patients",
       fill = "Stroke") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(hjust = 1),
    panel.grid.major = element_line(size = 0.1, linetype = 'dotted'),
    panel.grid.minor = element_blank()
  )

```

There is a higher rate of stroke associated with the 'Overweight' and 'Obese' BMI categories but perhaps not a significant level.
